<?php

/**
 * @file
 * Main Key Drupal project file.
 *
 * This file holds the main Drupal hook functions,
 * and API functions.
 *
 * @ingroup key
 */

/**
 * @defgroup key Key: Provides an API for key providers.
 *
 * Provides an API for defining and using key providers.
 */

function key_get($keyname) {
  $key_provider = key_get_key_provider($keyname);
//  $key =drupal_get_private_key();
  $key = key_get_key_from_key_provider($key_provider);

  return $key;
}

/**
 * Implements hook_ctools_plugin_directory().
 *
 * Tell ctools where to find plugins for this module.
 */
function key_ctools_plugin_directory($module, $plugin) {
  if ($module == 'key' && !empty($plugin)) {
    return "plugins/$plugin";
  }
}

/**
 * Implements hook_ctools_plugin_type().
 *
 * Tell ctools about our plugin types.
 */
function key_ctools_plugin_type() {
  $plugins = array();

  $plugins['key_providers'] = array(
    'cache' => TRUE,
    'cache table' => 'cache',
    'process' => '_key_plugin_process',
    'defaults' => array(
      'title' => '',
      'description' => '',
      'key callback' => NULL,
      'dependency callback' => NULL,
      'dependency errors' => NULL,
      'settings form' => NULL,
      'key options' => array(),
    ),
  );

  return $plugins;
}

/**
 * Implements hook_element_info().
 */
function key_element_info() {
  $elements['key'] = array(
    '#default_value' => '',
    '#input' => TRUE,
    '#process' => array('key_element_process'),
    '#value_callback' => 'key_element_value',
    '#element_validate' => array('key_element_element_validate'),
    '#theme_wrappers' => array('form_element'),
    '#tree' => TRUE,
    '#key_form_options' => array(),
    '#key_name_callback' => NULL,
  );

  return $elements;
}

/**
 * Process callback function for key element.
 */
function key_element_process(&$element, $form_state, $complete_form) {
  $key_name = call_user_func($element['#key_name_callback']);
  ctools_include('object-cache');
  ctools_object_cache_set('key_name', 'key_name', $key_name); 
  $field_name = $element['#array_parents'][count($element['#array_parents']) - 1];
  $wrapper_id = str_replace('_', '-', $field_name) . '-wrapper';

  $element['#prefix'] = '<div id="' . $wrapper_id . '">';
  $element['#suffix'] = '</div>';
  
  // Set Key field
  _key_process_key_field($element);

  // Set Provider
  _key_process_provider_field($element, $wrapper_id);  

  return $element;
}

/**
 * Callback for AJAX form re-rendering.
 */
function key_provider_additional_settings_ajax($form, $form_state) {
  $parents = _key_element_parents_cleanup($form_state['triggering_element']['#array_parents'], 'provider');
  $wrapper = drupal_array_get_nested_value($form, $parents);

  return $wrapper;
}

/**
 * Value callback for key element.
 */
function key_element_value($element, $input = FALSE, &$form_state) {
}

/**
 * Element validate callback for key element.
 */
function key_element_element_validate(&$element, &$form_state) {
  $parents = $element['#array_parents'];

  // Remove the key, so it doesn't get saved with the rest of the input.
  _key_remove_nested_array_element($form_state['values'], $parents, 'key');
}

/**
 * Fetch metadata on a specific key provider plugin.
 *
 * @param mixed $provider
 *   Name of a key provider method. If no $provider is specified, this
 *   function will return info about the default key provider.
 *
 * @return array
 *   An array with information about the requested key provider.
 */
function key_get_key_provider($provider = NULL) {
  if (empty($provider)) {
    watchdog('Key', 'Provider was not provided.', $provider);
    return FALSE;
  }

  ctools_include('plugins');
  $return = ctools_get_plugins('key', 'key_providers', $provider);
  watchdog('Key', 'key', $return);

  return $return;
}

/**
 * Returns info for all key providers.
 *
 * @param boolean $all
 *   A flag indicating whether to include plugins with unmet dependencies.
 *
 * @param boolean $reset
 *   A flag indicating whether to clear the plugin cache. Otherwise, this
 *   function may return stale data if plugin properties have changed.
 *
 * @return array
 *   An array of arrays with information about all available key providers.
 */
function key_get_key_providers($all = TRUE, $reset = FALSE) {
  if ($reset) {
    _key_clear_plugin_cache('key_providers');
  }

  ctools_include('plugins');
  $providers = ctools_get_plugins('key', 'key_providers');

  return $all ? $providers : array_filter($providers, '_key_plugin_is_valid');
}

/**
 * Get the key from a key provider.
 *
 * @param mixed $provider
 *   The key provider to retrieve the key for. Can be either the fully-loaded
 *   provider (from key_get_key_provider() or the name of the provider. If
 *   NULL, it assumes the default key provider.
 *
 * @return string
 *   The key.
 */
function key_get_key_from_key_provider($provider = NULL, $provider_settings = array()) {
  if (!is_array($provider)) {
    $provider = key_get_key_provider($provider);
  }
  $key_function = ctools_plugin_get_function($provider, 'key callback');
  $key = call_user_func($key_function, $provider_settings);

  return $key;
}

/**
 * Additional processing for plugins.
 */
function _key_plugin_process(&$plugin, $info) {
  // Calculate dependencies and attach any errors.
  if ($plugin['dependency callback'] && $dep_function = ctools_plugin_get_function($plugin, 'dependency callback')) {
    $plugin['dependency errors'] = call_user_func($dep_function);
  }
}

/**
 * Helper function to determine if a plugin has unmet dependencies. Most
 * helpful in conjunction with array_filter().
 *
 * @param $plugin array
 *   The plugin to check.
 *
 * @return boolean
 *   Whether or not the plugin is valid (has no unmet dependencies).
 */
function _key_plugin_is_valid($plugin) {
  if (isset($plugin['dependency errors']) && !empty($plugin['dependency errors'])) {
    return FALSE;
  }
  else {
    return TRUE;
  }
}

/**
 * Helper function to clear key plugin caches.
 */
function _key_clear_plugin_cache($type = NULL) {
  if ($type) {
    cache_clear_all("plugins:key:$type", 'cache');
  }
  else {
    cache_clear_all('plugins:key:', 'cache', TRUE);
  }
}

/**
 * Helper function to clean up a parents array.
 */
function _key_element_parents_cleanup($parents, $remove_last) {
  $last_parent_index = count($parents) - 1;
  foreach ((array) $remove_last as $remove_last_element) {
    if ($parents[$last_parent_index] == $remove_last_element) {
      unset($parents[$last_parent_index]);
    }
  }

  return $parents;
}

/**
 * Helper function to remove an arbitrarily-nested array element.
 */
function _key_remove_nested_array_element(&$array, $parents, $element) {
  $ref = &$array;
  foreach ($parents as $parent) {
    if (is_array($ref) && array_key_exists($parent, $ref)) {
      $ref = &$ref[$parent];
    }
  }
  unset($ref[$element]);
}

/**
 * Helper function to return provider options list for provider form.
 */
function _key_get_provider_options() {
  $providers = key_get_key_providers();
  $provider_options = array();

  if (!empty($providers)) {
    foreach($providers as $name => $provider) {
      $provider_options[$name] = $provider['title'];
    }
  }
  return $provider_options;
}

function _key_process_key_field(&$element) {
  $element['key'] = array(
    '#type' => 'textfield',
    '#size' => 50,
    '#required' => FALSE,
    '#title' => t('Key'),
    '#theme_wrappers' => array('form_element'),
  );
  // Set Key default value - included in first function
  if (isset($element['#default_value']['key'])) {
    $element['key']['#default_value'] = $element['#default_value']['key'];
  }
  return;
}

function _key_process_provider_field(&$element, $wrapper_id) {
  // Get dropdown options
  $provider_options = _key_get_provider_options();
  $element['provider'] = array(
    '#type' => 'select',
    '#options' => $provider_options,
    '#required' => $element['#required'],
    '#title' => t('Storage method'),
    '#theme_wrappers' => array('form_element'),
    '#ajax' => array(
      'method' => 'replace',
      'callback' => 'key_provider_additional_settings_ajax',
      'wrapper' => $wrapper_id,
    ),
  );
  
  // Set default value for provider - included in second function
  $provider = NULL;
  if (isset($element['#value']['provider'])) {
    $provider = $element['#value']['provider'];
  }
  elseif (isset($element['#default_value']['provider'])) {
    $provider = $element['#default_value']['provider'];
  }
  
  if ($provider) {
    $providers = key_get_key_providers();
    $element['provider']['#default_value'] = $provider;
    $provider_settings = (isset($element['#default_value']['provider_settings'])) ? $element['#default_value']['provider_settings'] : array();
    $element['key']['#default_value'] = key_get_key_from_key_provider($provider, $provider_settings);
    // ctools_get_plugins_reset();
    
    if ($provider_settings_form = ctools_plugin_get_function($providers[$provider], 'settings form')) {
      $element['provider_settings'] = array(
        '#type' => 'fieldset',
        '#title' => t('Storage method settings'),
        '#tree' => TRUE,
        '#collapsible' => TRUE,
        '#collapsed' => FALSE,
      );

      if (isset($element['#default_value']['provider_settings'])) {
        $provider_settings_defaults = $element['#default_value']['provider_settings'];
      }
      else {
        $provider_settings_defaults = array();
      }
      $element['provider_settings'] += call_user_func($provider_settings_form, $provider_settings_defaults);
    }
  }
  elseif (array_key_exists('variable', $provider_options)) {
    $element['provider']['#default_value'] = 'variable';
  }

  return;
}